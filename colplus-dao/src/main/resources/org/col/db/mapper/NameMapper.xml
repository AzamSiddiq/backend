<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.col.db.mapper.NameMapper">

    <sql id="minimalNameCols">
        ${alias}.id AS ${prefix}id,
        ${alias}.scientific_name AS ${prefix}scientific_name,
        ${alias}.authorship AS ${prefix}authorship,
        ${alias}.rank AS ${prefix}rank,
        ${alias}.uninomial AS ${prefix}uninomial,
        ${alias}.genus AS ${prefix}genus,
        ${alias}.infrageneric_epithet AS ${prefix}infrageneric_epithet,
        ${alias}.specific_epithet AS ${prefix}specific_epithet,
        ${alias}.infraspecific_epithet AS ${prefix}infraspecific_epithet,
        ${alias}.cultivar_epithet AS ${prefix}cultivar_epithet,
        ${alias}.strain AS ${prefix}strain,
        ${alias}.candidatus AS ${prefix}candidatus,
        ${alias}.notho AS ${prefix}notho,
        ${alias}.basionym_authors AS ${prefix}basionym_authors,
        ${alias}.basionym_ex_authors AS ${prefix}basionym_ex_authors,
        ${alias}.basionym_year AS ${prefix}basionym_year,
        ${alias}.combination_authors AS ${prefix}combination_authors,
        ${alias}.combination_ex_authors AS ${prefix}combination_ex_authors,
        ${alias}.combination_year AS ${prefix}combination_year,
        ${alias}.sanctioning_author AS ${prefix}sanctioning_author,
        ${alias}.code AS ${prefix}code
    </sql>

    <sql id="nameCols">
        <include refid="org.col.db.mapper.NameMapper.minimalNameCols" />,
        ${alias}.dataset_key AS ${prefix}dataset_key,
        ${alias}.verbatim_key AS ${prefix}verbatim_key,
        ${alias}.name_index_id AS ${prefix}name_index_id,
        ${alias}.homotypic_name_id AS ${prefix}homotypic_name_id,
        ${alias}.published_in_id AS ${prefix}published_in_id,
        ${alias}.published_in_page AS ${prefix}published_in_page,
        ${alias}.nom_status AS ${prefix}nom_status,
        ${alias}.origin AS ${prefix}origin,
        ${alias}.type AS ${prefix}type,
        ${alias}.webpage AS ${prefix}webpage,
        ${alias}.fossil AS ${prefix}fossil,
        ${alias}.remarks AS ${prefix}remarks,
        ${alias}.created AS ${prefix}created,
        ${alias}.created_by AS ${prefix}created_by,
        ${alias}.modified AS ${prefix}modified,
        ${alias}.modified_by AS ${prefix}modified_by
    </sql>

    <sql id="SELECT">
        <include refid="org.col.db.mapper.NameMapper.nameCols">
            <property name="alias" value="n"/>
            <property name="prefix" value=""/>
        </include>
    </sql>


    <sql id="COLS">
        id,
        dataset_key,
        verbatim_key,
        name_index_id,
        homotypic_name_id,
        scientific_name,
        authorship,
        rank,
        uninomial,
        genus,
        infrageneric_epithet,
        specific_epithet,
        infraspecific_epithet,
        cultivar_epithet,
        strain,
        candidatus,
        notho,
        basionym_authors,
        basionym_ex_authors,
        basionym_year,
        combination_authors,
        combination_ex_authors,
        combination_year,
        sanctioning_author,
        published_in_id,
        published_in_page,
        code,
        nom_status,
        origin,
        type,
        webpage,
        fossil,
        remarks,
        created_by,
        modified_by
    </sql>

    <sql id="PROPS">
        #{id},
        #{datasetKey},
        #{verbatimKey},
        #{nameIndexId},
        #{homotypicNameId},
        #{scientificName},
        #{authorship},
        #{rank}::rank,
        #{uninomial},
        #{genus},
        #{infragenericEpithet},
        #{specificEpithet},
        #{infraspecificEpithet},
        #{cultivarEpithet},
        #{strain},
        #{candidatus},
        #{notho},
        #{basionymAuthorship.authors, typeHandler=org.col.db.type.StringArrayTypeHandler},
        #{basionymAuthorship.exAuthors, typeHandler=org.col.db.type.StringArrayTypeHandler},
        #{basionymAuthorship.year},
        #{combinationAuthorship.authors, typeHandler=org.col.db.type.StringArrayTypeHandler},
        #{combinationAuthorship.exAuthors,
        typeHandler=org.col.db.type.StringArrayTypeHandler},
        #{combinationAuthorship.year},
        #{sanctioningAuthor},
        #{publishedInId},
        #{publishedInPage},
        #{code},
        #{nomStatus},
        #{origin},
        #{type},
        #{webpage},
        #{fossil},
        #{remarks},
        #{createdBy},
        #{modifiedBy}
    </sql>

    <sql id="FROM">name n</sql>

     <!-- A mapping to Name, mostly auto mapped -->
    <resultMap id="nameResultMap" type="Name" autoMapping="true">
        <id property="id" column="id" />
        <association property="combinationAuthorship" javaType="Authorship">
            <result property="authors" column="combination_authors" typeHandler="org.col.db.type.StringArrayTypeHandler" />
            <result property="exAuthors" column="combination_ex_authors" typeHandler="org.col.db.type.StringArrayTypeHandler" />
            <result property="year" column="combination_year" />
        </association>
        <association property="basionymAuthorship" javaType="Authorship">
            <result property="authors" column="basionym_authors" typeHandler="org.col.db.type.StringArrayTypeHandler" />
            <result property="exAuthors" column="basionym_ex_authors" typeHandler="org.col.db.type.StringArrayTypeHandler" />
            <result property="year" column="basionym_year" />
        </association>
    </resultMap>

    <select id="count" resultType="integer">
        <include refid="org.col.db.mapper.Common.countFromFinishedDatasetImport">
            <property name="column" value="name_count"/>
        </include>
    </select>

    <select id="list" resultMap="nameResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE n.dataset_key = #{datasetKey}
        ORDER BY id
        <include refid="org.col.db.mapper.Common.limit" />
    </select>

    <select id="listByReference" resultMap="nameResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE n.dataset_key = #{datasetKey} AND n.published_in_id = #{refId}
        ORDER BY id
    </select>

    <!--  select all names of a dataset
     Using a optimal fetchsize to enable low memory footprint while keeping good performance using a resulthandler
    -->
    <select id="processDataset" parameterType="map" resultMap="nameResultMap" resultOrdered="true"
            fetchSize="10000" resultSetType="FORWARD_ONLY">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE n.dataset_key = #{datasetKey}
        ORDER BY id
    </select>

    <select id="get" resultMap="nameResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE n.dataset_key = #{datasetKey} AND n.id = #{id}
    </select>

    <select id="getByTaxon" resultMap="nameResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
            JOIN taxon t ON t.name_id=n.id AND t.dataset_key = n.dataset_key
        WHERE n.dataset_key = #{datasetKey} AND t.id = #{taxonId}
    </select>

    <select id="listNameIndexIds" resultType="String" >
        SELECT DISTINCT name_index_id
        FROM name_${datasetKey}
        <if test="sectorKey != null">
            WHERE sector_key = #{sectorKey}
        </if>
    </select>

    <select id="homotypicGroup" resultMap="nameResultMap">
        SELECT <include refid="SELECT" />
        FROM name ns
          JOIN name n ON n.homotypic_name_id=ns.homotypic_name_id
        WHERE ns.dataset_key = #{datasetKey} AND ns.id=#{id}
    </select>

    <select id="indexGroup" resultMap="nameResultMap">
        SELECT <include refid="SELECT" />
        FROM name n
        WHERE n.name_index_id=#{id}
    </select>

    <insert id="create" parameterType="Name" useGeneratedKeys="false" keyProperty="id">
        INSERT INTO name_${datasetKey} (<include refid="COLS" />, created, modified)
        VALUES (<include refid="PROPS" />, now(), now())
    </insert>

    <update id="update" parameterType="Name" keyProperty="id">
        UPDATE name_${datasetKey} (<include refid="COLS" />, created, modified)
        VALUES (<include refid="PROPS" />, now(), now())
    </update>

    <delete id="delete" parameterType="map">
        DELETE name_${datasetKey} WHERE id = #{id}
    </delete>

    <delete id="deleteOrphans" parameterType="map">
        DELETE FROM name_${datasetKey} n
        USING taxon_${datasetKey} t, synonym__${datasetKey} s
        WHERE id = #{datasetKey}
    </delete>

</mapper>
