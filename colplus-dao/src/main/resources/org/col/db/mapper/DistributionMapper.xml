<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.col.db.mapper.DistributionMapper">

  <sql id="SELECT">
    d.key,
    d.taxon_id,
    d.verbatim_key,
    d.area,
    d.gazetteer,
    d.status,
    dr.reference_id
  </sql>

  <sql id="COLS">
    dataset_key,
    taxon_id,
    verbatim_key,
    area,
    gazetteer,
    status
  </sql>

  <sql id="PROPS">
    #{datasetKey},
    #{taxonId},
    #{d.verbatimKey},
    #{d.area},
    #{d.gazetteer},
    #{d.status}
  </sql>

  <sql id="FROM">
    distribution d LEFT JOIN distribution_reference dr ON d.key=dr.distribution_key
  </sql>

  <!-- A mapping to Distribution, mostly auto mapped -->
  <resultMap id="distributionResultMap" type="Distribution" autoMapping="true">
    <id property="key" column="key" />
    <collection property="referenceIds" ofType="String">
        <result column="reference_id"/>
    </collection>
  </resultMap>


  <select id="listByTaxon" resultMap="distributionResultMap">
    SELECT <include refid="SELECT" />
    FROM <include refid="FROM" />
    WHERE d.taxon_id = #{taxonId} AND d.dataset_key = #{datasetKey}
    ORDER BY d.key
  </select>

  <select id="get" resultMap="distributionResultMap">
    SELECT <include refid="SELECT" />
    FROM <include refid="FROM" />
    WHERE d.key = #{key} AND d.dataset_key = #{datasetKey}
  </select>

  <insert id="create" parameterType="Distribution" useGeneratedKeys="true" keyProperty="d.key">
    INSERT INTO distribution_${datasetKey} ( <include refid="COLS" /> )
    VALUES ( <include refid="PROPS" /> )
  </insert>

</mapper>
