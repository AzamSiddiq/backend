<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.col.db.mapper.ReferenceMapper">

    <sql id="SELECT">
        r.id,
        r.dataset_key,
        r.verbatim_key,
        r.csl,
        r.citation,
        r.year,
        r.created,
        r.created_by,
        r.modified,
        r.modified_by
    </sql>

    <sql id="COLS">
        id,
        dataset_key,
        verbatim_key,
        csl,
        citation,
        year,
        created_by,
        modified_by
    </sql>

    <sql id="PROPS">
        #{id},
        #{datasetKey},
        #{verbatimKey},
        #{csl, typeHandler=org.col.db.type.CslJsonHandler}::jsonb,
        #{citation},
        #{year},
        #{createdBy},
        #{modifiedBy}
    </sql>

    <sql id="FROM">
        reference r
    </sql>

    <!-- A mapping to Reference, mostly auto mapped -->
    <resultMap id="referenceResultMap" type="Reference" autoMapping="true">
        <id property="id" column="id" />
        <result property="year" column="year" />
        <result property="csl" column="csl" typeHandler="org.col.db.type.CslJsonHandler" />
    </resultMap>

    <select id="count" resultType="integer">
        <include refid="org.col.db.mapper.Common.countFromFinishedDatasetImport">
            <property name="column" value="reference_count"/>
        </include>
    </select>

    <select id="list" resultMap="referenceResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE r.dataset_key = #{datasetKey}
        ORDER BY id
        <include refid="org.col.db.mapper.Common.limit" />
    </select>

    <select id="listByIds" resultMap="referenceResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE r.dataset_key = #{datasetKey} AND id IN
        <foreach item="k" index="idx" collection="ids"
                 open="(" separator="," close=")">
            #{k}
        </foreach>
    </select>

    <select id="get" resultMap="referenceResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE r.id = #{id} AND r.dataset_key = #{datasetKey}
    </select>

    <insert id="create" parameterType="Reference" useGeneratedKeys="true" keyProperty="key">
        INSERT INTO reference_${datasetKey} ( <include refid="COLS" />, created, modified)
        VALUES ( <include refid="PROPS" />, now(), now())
    </insert>

    <insert id="linkToTaxon">
        INSERT INTO taxon_reference_${datasetKey} (dataset_key, taxon_id, reference_id)
        VALUES ( #{datasetKey}, #{taxonId}, #{referenceId} )
    </insert>

    <select id="listByTaxon" resultType="string">
        SELECT reference_id
        FROM taxon_reference
        WHERE dataset_key = #{datasetKey}
            AND taxon_id = #{taxonId}
    </select>

</mapper>
