<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.col.db.mapper.SynonymMapper">

    <sql id="synCols">
        ${alias}.status AS ${prefix}status,
        ${alias}.according_to AS ${prefix}according_to
    </sql>

    <sql id="SELECT">
        <include refid="synCols">
            <property name="alias" value="s"/>
            <property name="prefix" value=""/>
        </include>,
        <include refid="org.col.db.mapper.NameMapper.nameCols">
            <property name="alias" value="n"/>
            <property name="prefix" value="n_"/>
        </include>,
        <include refid="org.col.db.mapper.TaxonMapper.taxonCols">
            <property name="alias" value="a"/>
            <property name="prefix" value="a_"/>
        </include>,
        <include refid="org.col.db.mapper.NameMapper.nameCols">
            <property name="alias" value="an"/>
            <property name="prefix" value="a_n_"/>
        </include>
    </sql>

    <sql id="FROM">
        synonym s
        JOIN name n ON n.key=s.name_key
        JOIN taxon a ON a.key=s.taxon_key
        JOIN name an ON an.key=a.name_key
    </sql>


    <resultMap id="synonymResultMap" type="Synonym" autoMapping="true">
        <association property="name" javaType="Name" resultMap="org.col.db.mapper.NameMapper.nameResultMap" columnPrefix="n_" />
        <association property="accepted" javaType="Taxon" resultMap="org.col.db.mapper.TaxonMapper.taxonResultMap" columnPrefix="a_" />
    </resultMap>

    <select id="listByName" resultMap="synonymResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE n.key = #{nameKey}
    </select>


    <select id="listByTaxon" resultMap="synonymResultMap">
        SELECT <include refid="SELECT" />
        FROM <include refid="FROM" />
        WHERE s.taxon_key = #{taxonKey}
        ORDER BY n.homotypic_name_key
    </select>

    <insert id="create" parameterType="Synonym">
        INSERT INTO synonym (dataset_key, name_key, taxon_key, status, according_to)
        VALUES (#{syn.name.datasetKey}, #{syn.name.key}, #{syn.accepted.key}, #{syn.status}, #{syn.accordingTo})
    </insert>

</mapper>
