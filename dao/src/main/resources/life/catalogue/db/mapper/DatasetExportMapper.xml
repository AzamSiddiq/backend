<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="life.catalogue.db.mapper.DatasetExportMapper">

  <sql id="SELECT">
    de.key,
    de.dataset_key,
    de.format,
    de.excel,
    de.root,
    de.synonyms,
    de.min_rank,
    de.created_by,
    de.modified_by,
    de.import_attempt,
    de.started,
    de.finished,
    de.deleted,
    de.classification,
    de.status,
    de.error,
    de.md5,
    de.size,
    de.synonym_count,
    de.taxon_count,
    de.taxa_by_rank_count,
    de.created,
    de.modified
  </sql>

  <sql id="COLS">
    key,
    dataset_key,
    format,
    excel,
    root,
    synonyms,
    min_rank,
    created_by,
    modified_by,
    import_attempt,
    started,
    finished,
    deleted,
    classification,
    status,
    error,
    md5,
    size,
    synonym_count,
    taxon_count,
    taxa_by_rank_count
  </sql>

  <sql id="PROPS">
    #{key},
    #{request.datasetKey},
    #{request.format}::DATAFORMAT,
    #{request.excel},
    #{request.root, typeHandler=life.catalogue.db.type2.SimpleNameTypeHandler}::SIMPLE_NAME,
    #{request.synonyms},
    #{request.minRank}::RANK,
    #{createdBy},
    #{modifiedBy},
    #{importAttempt},
    #{started},
    #{finished},
    #{deleted},
    #{classification, typeHandler=life.catalogue.db.type2.SimpleNameArrayTypeHandler}::SIMPLE_NAME[],
    #{status}::JOBSTATUS,
    #{error},
    #{md5},
    #{size},
    #{synonymCount},
    #{taxonCount},
    #{taxaByRankCount, typeHandler=life.catalogue.db.type2.HstoreRankCountTypeHandler}::hstore
  </sql>

  <sql id="FROM">
    dataset_export de
  </sql>

  <resultMap id="datasetExportResultMap" type="DatasetExport" autoMapping="true">
    <result property="taxaByRankCount" column="taxa_by_rank_count" typeHandler="life.catalogue.db.type2.HstoreRankCountTypeHandler"/>
    <result property="classification" column="classification" typeHandler="life.catalogue.db.type2.SimpleNameArrayTypeHandler"/>
    <association property="request" javaType="ExportRequest" resultMap="life.catalogue.db.mapper.DatasetExportMapper.exportRequestResultMap"/>
  </resultMap>

  <resultMap id="exportRequestResultMap" type="ExportRequest" autoMapping="true">
    <result property="root" column="root" typeHandler="life.catalogue.db.type2.SimpleNameTypeHandler"/>
  </resultMap>


  <select id="get" resultMap="datasetExportResultMap">
    SELECT <include refid="SELECT"/>
    FROM <include refid="FROM"/>
    WHERE key=#{key}
  </select>

  <insert id="create" parameterType="DatasetExport">
    INSERT INTO dataset_export (<include refid="COLS"/>, created)
    VALUES (<include refid="PROPS"/>, #{created})
  </insert>

  <update id="update" parameterType="DatasetExport">
    UPDATE dataset_export
    SET (<include refid="COLS"/>, modified) = (<include refid="PROPS"/>, now())
    WHERE key=#{key}
  </update>

  <delete id="delete" parameterType="map">
    UPDATE dataset_export SET deleted = now() WHERE key=#{key}
  </delete>

  <select id="list" resultMap="datasetExportResultMap">
    SELECT <include refid="SELECT"/>
    FROM <include refid="FROM"/>
    ORDER BY created DESC
  </select>

  <select id="count" resultType="integer">
    SELECT count(*)
    FROM <include refid="FROM"/>
  </select>

  <select id="search" resultMap="datasetExportResultMap">
    SELECT <include refid="SELECT"/>
    FROM <include refid="FROM"/>
      JOIN dataset d ON d.key=de.dataset_key
    WHERE de.dataset_key = #{datasetKey}
      AND COALESCE(de.import_attempt,-1) = COALESCE(d.import_attempt,-1)
      AND de.format = #{format}::DATAFORMAT
      AND de.excel = #{excel}
      AND de.synonyms = #{synonyms}
      -- nullable
      AND de.min_rank <if test="minRank == null">IS NULL</if><if test="minRank != null">= #{minRank}::RANK</if>
      AND <if test="root == null">de.root IS NULL</if><if test="root != null">(de.root).id = #{root.id}</if>
      -- exclude failed exports
      AND de.status NOT IN ('CANCELED', 'FAILED')
    ORDER BY de.created DESC
    LIMIT 1
  </select>

</mapper>
